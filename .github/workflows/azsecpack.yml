run-name: ${{ inputs.AGENT_SPEC }}-${{ inputs.IMAGE_VERSION }} azseckpac test
on:
  workflow_dispatch:
    inputs:
      IMAGE_VERSION:
        description: 'image version'
        required: false
      AGENT_SPEC:
        description: 'OS platform'
        required: false  
        
jobs: 
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.build_matrix.outputs.runner }}
    steps:
      - name: Build matrix
        id: build_matrix
        shell: pwsh
        run: |
          $matrixJson = $( ${{ inputs.AGENT_SPEC }}).Split(',').Trim() | ConvertTo-Json -AsArray
          "runner=$matrixJson" | Out-File -Append -FilePath $env:GITHUB_OUTPUT
      
  azsecpackw19:
    needs: [build-matrix]
    strategy:
      matrix:
        os: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    if: contains(${{ inputs.AGENT_SPEC }}, 'windows-2019')
    name: run test on ${{ inputs.AGENT_SPEC }}
    steps:
      - name: repo checkout
        uses: actions/checkout@v3
      - name: run test
        uses: ./.github/actions/azsecpack-win  
    
  azsecpackw22:
    needs: [build-matrix]
    strategy:
      matrix:
        os: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    if: contains(${{ inputs.AGENT_SPEC }}, 'windows-2022')
    name: run test on ${{ inputs.AGENT_SPEC }}
    steps:
      - name: repo checkout
        uses: actions/checkout@v3
      - name: run test
        uses: ./.github/actions/azsecpack-win

  azsecpacku20:
    needs: [build-matrix]
    strategy:
      matrix:
        os: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    if: contains(${{ inputs.AGENT_SPEC }}, 'ubuntu-20.04')
    name: run test on ${{ inputs.AGENT_SPEC }}
    steps:
      - name: repo checkout
        uses: actions/checkout@v3
      - name: run test
        uses: ./.github/actions/azsecpacl-ubnt

  azsecpacku22:
    needs: [build-matrix]
    strategy:
      matrix:
        os: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    if: contains(${{ inputs.AGENT_SPEC }}, 'ubuntu-22.04')
    name: run test on ${{ inputs.AGENT_SPEC }}
    steps:
      - name: repo checkout
        uses: actions/checkout@v3
      - name: run test
        uses: ./.github/actions/azsecpacl-ubnt
